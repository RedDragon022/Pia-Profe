<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Contactos</title>
  <link rel="stylesheet" href="Estilos.css">
  <meta name="theme-color" content="#312e81" id="meta-theme-color">
  <script src="assets/js/theme-toggle.js" defer></script>
  <script defer>
    (function(){
      const el = document.getElementById('meta-theme-color');
      function applyThemeColor(){
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        el && el.setAttribute('content', isDark ? '#1e1b4b' : '#312e81');
      }
      document.addEventListener('DOMContentLoaded', applyThemeColor);
      const obs = new MutationObserver(applyThemeColor);
      obs.observe(document.documentElement, { attributes:true, attributeFilter:['data-theme'] });
    })();
  </script>
  
</head>
<body>
  <header>
    <h1>Administración de Contactos</h1>
    <p><a class="btn btn-secondary" href="index.html"><i class="fas fa-home"></i> Volver al sitio</a></p>
  </header>

  <main class="admin-container">
    <!-- Login Form -->
    <div id="login-view" class="admin-card">
      <form id="login-form">
        <h2>Iniciar Sesión</h2>
        <div id="error-message" class="error-text"></div>
        <div class="form-group">
          <label for="username">Usuario</label>
          <input type="text" id="username" required>
        </div>
        <div class="form-group">
          <label for="password">Contraseña</label>
          <input type="password" id="password" required>
        </div>
        <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Entrar</button>
      </form>
    </div>

    <!-- Admin Content (hidden by default) -->
    <div id="admin-content" class="admin-card hidden">
      <h2>Contactos Recibidos</h2>
      <div class="admin-actions">
        <button id="logout" class="btn btn-secondary"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
        <button id="refresh" class="btn btn-secondary"><i class="fas fa-sync"></i> Refrescar</button>
        <button id="export" class="btn btn-primary"><i class="fas fa-file-csv"></i> Exportar CSV</button>
      </div>
      <div id="list"></div>
    </div>
  </main>

  <script>
    const loginView = document.getElementById('login-view');
    const adminContent = document.getElementById('admin-content');
    const loginForm = document.getElementById('login-form');
    const errorMessage = document.getElementById('error-message');
    const logoutButton = document.getElementById('logout');
    const TOKEN_KEY = 'invomex_auth_token';

    // --- Authentication Logic ---

  const API_BASE = window.INVOMEX_API_BASE || '';

  loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMessage.textContent = '';
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
  const res = await fetch(`${API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.success) {
          sessionStorage.setItem(TOKEN_KEY, data.token);
          showAdminView();
        } else {
          errorMessage.textContent = data.error || 'Error al iniciar sesión.';
        }
      } catch (err) {
        errorMessage.textContent = 'Error de conexión con el servidor.';
      }
    });

    logoutButton.addEventListener('click', () => {
      sessionStorage.removeItem(TOKEN_KEY);
      showLoginView();
    });

    function showLoginView() {
      // Mostrar login y ocultar panel admin
      loginView.classList.remove('hidden');
      adminContent.classList.add('hidden');
    }

    function showAdminView() {
      // Ocultar login y mostrar panel admin
      loginView.classList.add('hidden');
      adminContent.classList.remove('hidden');
      loadContacts();
    }

    // --- Contact Management Logic ---

    async function fetchContacts() {
      const token = sessionStorage.getItem(TOKEN_KEY);
      const res = await fetch(`${API_BASE}/api/contacts`, {
        headers: { 'Authorization': token }
      });

      if (res.status === 403) {
          // Token is invalid or expired
          logoutButton.click();
          throw new Error('Sesión inválida. Por favor, inicie sesión de nuevo.');
      }
      if (!res.ok) {
          throw new Error('No fue posible obtener los contactos');
      }
      const body = await res.json();
      return body.contacts || [];
    }

    function renderTable(items) {
      if (!items.length) {
        document.getElementById('list').innerHTML = '<p>No hay registros</p>';
        return;
      }
      const rows = items.map(c => `
        <tr>
          <td>${c.id}</td>
          <td>${escapeHtml(c.name)}</td>
          <td>${escapeHtml(c.email)}</td>
          <td>${escapeHtml(c.empresa || '')}</td>
          <td>${escapeHtml(c.telefono || '')}</td>
          <td>${escapeHtml(c.servicio || '')}</td>
          <td>${escapeHtml(c.message || '')}</td>
          <td>${new Date(c.created_at).toLocaleString()}</td>
        </tr>
      `).join('');

      document.getElementById('list').innerHTML = `
        <table class="admin-table">
          <thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Empresa</th><th>Tel</th><th>Servicio</th><th>Mensaje</th><th>Fecha</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function toCSV(items) {
      const header = ['id', 'name', 'email', 'empresa', 'telefono', 'servicio', 'message', 'created_at'];
      const lines = [header.join(',')];
      for (const c of items) {
        const row = header.map(k => '"' + ((c[k] || '').toString().replace(/"/g, '""')) + '"');
        lines.push(row.join(','));
      }
      return lines.join('\n');
    }
    
    async function loadContacts() {
        try {
            const items = await fetchContacts();
            renderTable(items);
        } catch (e) {
            alert(e.message || 'Error');
        }
    }

    document.getElementById('refresh').addEventListener('click', loadContacts);

    document.getElementById('export').addEventListener('click', async () => {
      try {
        const items = await fetchContacts();
        const csv = toCSV(items);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'contacts.csv';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert(e.message || 'Error');
      }
    });

    // --- Initial Check ---
    // Check if a token exists and switch to the appropriate view
    if (sessionStorage.getItem(TOKEN_KEY)) {
      showAdminView();
    } else {
      showLoginView();
    }
  </script>
</body>
</html>
